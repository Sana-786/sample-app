pipeline {
  agent any
  environment {
    AWS_REGION = 'ap-south-1'
    ECR_REPO = '967931774168.dkr.ecr.ap-south-1.amazonaws.com/sample-app'
    IMAGE_TAG = "v${BUILD_NUMBER}"
  }
  stages {
    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/<your-username>/sample-app.git'
      }
    }

    stage('Build Docker Image') {
      steps {
        script {
          docker.build("${ECR_REPO}:${IMAGE_TAG}")
        }
      }
    }

    stage('Login & Push to ECR') {
      steps {
        script {
          withAWS(region: "${AWS_REGION}", credentials: 'aws-creds') {
            sh "aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REPO}"
            sh "docker push ${ECR_REPO}:${IMAGE_TAG}"
          }
        }
      }
    }

    stage('Update Kubernetes Manifest') {
      steps {
        script {
          sh """
          sed -i 's|image: .*|image: ${ECR_REPO}:${IMAGE_TAG}|' manifests/deployment.yaml
          git config --global user.email "jenkins@local"
          git config --global user.name "Jenkins"
          git add manifests/deployment.yaml
          git commit -m "Updated image to ${IMAGE_TAG}"
          git push origin main
          """
        }
      }
    }
  }
}
